using Iris.Runtime.Model.DisignSuport;
using Databridge.Engine;
using System.Linq;
using System;
using System.Collections.Generic;
using System.Text;
using System.Runtime.Serialization.Formatters.Binary;
using System.IO;
using System.Data;
using System.ComponentModel;
using System.Drawing.Design;
using System.Drawing;
using Databridge.Interfaces.BaseEditors;

using Iris.Interfaces;
using Databridge.Engine.Compression;
using Iris.Runtime.Core;
using Iris.Runtime.Core.Connections;
using Iris.Runtime.Model.Entities;
using Iris.Runtime.Model.ClientObjects;

[assembly: OperationPluginAssembly]
namespace Iris.Runtime.Model.BaseObjects
{
  [OperationCategory("Dynamic Plugins", "DynStructure"), Serializable]
  public class DynStructure : Operation
  {
    [DisplayName("Msg"), Description(""), Category("Parâmetros")]
    public System.String s
    {
      get
      {
        Object result = ((ScalarVar)structure.GetObject("s", "scalarVars")).RawValue;
        return result as System.String;
      }
      set { ((ScalarVar)structure.GetObject("s", "scalarVars")).RawValue = value; }
    }

    private Structure structure;

    public DynStructure(Structure aStructure, string aName)
      : base(aStructure, aName)
    {
      byte[] buffer = new byte[] { 80, 75, 3, 4, 20, 0, 0, 0, 8, 0, 2, 133, 51, 65, 255, 203, 203, 154, 224, 8, 0, 0, 72, 41, 0, 0, 0, 0, 0, 0, 237, 90, 221, 107, 28, 201, 17, 159, 214, 126, 175, 180, 178, 117, 242, 103, 114, 196, 227, 56, 138, 165, 88, 55, 145, 44, 75, 62, 249, 227, 14, 123, 37, 91, 138, 245, 117, 90, 157, 238, 46, 90, 101, 221, 59, 211, 90, 143, 53, 59, 179, 233, 158, 149, 180, 119, 132, 188, 135, 60, 29, 4, 242, 148, 167, 4, 14, 66, 2, 129, 64, 32, 16, 8, 28, 4, 2, 129, 64, 32, 144, 231, 16, 238, 223, 112, 170, 122, 102, 118, 103, 215, 43, 105, 37, 175, 184, 19, 190, 145, 221, 154, 233, 174, 174, 223, 175, 123, 170, 171, 171, 122, 164, 16, 69, 81, 94, 192, 133, 191, 241, 234, 235, 129, 98, 101, 158, 155, 66, 91, 173, 218, 174, 89, 102, 218, 162, 99, 48, 107, 84, 93, 103, 92, 152, 142, 125, 127, 74, 187, 57, 54, 126, 83, 155, 30, 159, 214, 198, 39, 166, 71, 213, 108, 213, 114, 171, 156, 221, 183, 89, 213, 229, 20, 4, 87, 170, 69, 203, 212, 159, 176, 218, 154, 179, 205, 236, 251, 118, 213, 178, 250, 34, 160, 245, 189, 92, 77, 184, 172, 172, 205, 112, 186, 107, 218, 165, 134, 198, 91, 218, 24, 254, 28, 174, 170, 56, 54, 177, 53, 185, 117, 123, 107, 124, 220, 152, 28, 163, 19, 180, 47, 10, 106, 231, 195, 100, 219, 210, 156, 158, 232, 144, 101, 12, 212, 45, 72, 117, 243, 182, 203, 248, 22, 213, 153, 104, 175, 241, 86, 135, 26, 227, 160, 113, 169, 105, 54, 179, 14, 223, 135, 229, 84, 103, 58, 99, 248, 170, 134, 95, 126, 67, 218, 67, 42, 216, 114, 241, 57, 211, 93, 161, 229, 92, 94, 213, 81, 213, 121, 16, 78, 26, 212, 165, 107, 181, 10, 75, 83, 33, 88, 25, 52, 50, 209, 107, 48, 161, 115, 179, 226, 2, 139, 94, 195, 20, 21, 139, 214, 150, 104, 153, 37, 117, 234, 178, 146, 195, 107, 81, 83, 119, 236, 180, 112, 41, 119, 87, 28, 211, 118, 123, 157, 170, 91, 169, 122, 247, 23, 13, 182, 69, 129, 234, 236, 158, 206, 164, 134, 57, 106, 27, 22, 227, 131, 166, 144, 119, 240, 118, 235, 77, 113, 206, 4, 136, 246, 242, 170, 109, 67, 253, 114, 133, 241, 126, 221, 98, 148, 47, 219, 171, 76, 170, 239, 215, 29, 203, 2, 214, 203, 118, 22, 235, 211, 14, 136, 80, 236, 42, 122, 129, 130, 13, 45, 120, 159, 22, 58, 181, 40, 95, 167, 92, 164, 61, 149, 57, 230, 138, 132, 208, 159, 177, 50, 21, 41, 221, 130, 177, 225, 0, 46, 220, 91, 114, 92, 38, 222, 217, 46, 20, 30, 82, 125, 27, 32, 31, 153, 204, 50, 34, 17, 66, 72, 20, 46, 5, 254, 41, 120, 19, 37, 228, 138, 111, 145, 239, 219, 166, 91, 203, 49, 110, 82, 203, 252, 88, 66, 207, 57, 150, 193, 248, 127, 137, 47, 144, 245, 24, 34, 15, 237, 49, 179, 65, 82, 215, 102, 76, 89, 65, 121, 237, 233, 205, 141, 13, 95, 16, 230, 93, 154, 118, 89, 232, 14, 183, 204, 226, 113, 140, 252, 246, 109, 58, 169, 79, 78, 141, 79, 79, 220, 98, 99, 111, 79, 111, 142, 158, 164, 242, 205, 115, 205, 171, 82, 155, 47, 211, 18, 195, 229, 122, 163, 141, 137, 45, 215, 95, 13, 76, 137, 237, 114, 199, 210, 178, 89, 104, 137, 118, 96, 146, 245, 190, 61, 71, 21, 38, 23, 91, 214, 164, 54, 63, 11, 29, 221, 90, 236, 24, 52, 9, 249, 5, 57, 4, 28, 155, 23, 76, 225, 62, 29, 223, 216, 120, 9, 185, 174, 123, 84, 237, 166, 167, 216, 220, 68, 87, 241, 217, 145, 169, 133, 221, 10, 14, 54, 88, 46, 218, 76, 205, 110, 60, 250, 92, 187, 230, 131, 60, 182, 191, 62, 54, 91, 79, 84, 190, 68, 240, 69, 90, 46, 88, 218, 45, 60, 187, 176, 243, 116, 153, 233, 106, 224, 121, 78, 138, 233, 175, 94, 145, 105, 78, 250, 67, 111, 121, 156, 20, 71, 92, 147, 169, 4, 22, 73, 40, 210, 112, 165, 82, 242, 70, 241, 110, 136, 146, 74, 99, 107, 47, 22, 125, 88, 100, 176, 232, 135, 34, 126, 6, 99, 12, 176, 205, 250, 6, 21, 63, 139, 97, 71, 20, 213, 29, 230, 142, 209, 43, 69, 103, 96, 47, 75, 73, 9, 220, 209, 250, 30, 120, 59, 154, 220, 187, 136, 66, 146, 241, 1, 16, 202, 52, 57, 76, 92, 245, 241, 55, 160, 120, 210, 69, 199, 25, 197, 161, 191, 14, 251, 3, 206, 94, 194, 215, 147, 204, 58, 229, 10, 229, 140, 39, 231, 168, 120, 150, 51, 63, 102, 25, 232, 185, 78, 173, 42, 91, 161, 38, 23, 74, 68, 137, 36, 63, 61, 104, 82, 252, 223, 179, 63, 174, 194, 187, 117, 107, 129, 62, 52, 230, 147, 28, 68, 242, 139, 131, 72, 133, 199, 112, 170, 223, 213, 198, 230, 207, 113, 161, 13, 66, 49, 132, 55, 231, 160, 136, 165, 142, 184, 73, 226, 74, 137, 234, 112, 51, 88, 151, 184, 225, 216, 143, 168, 105, 1, 153, 166, 186, 92, 85, 135, 109, 79, 156, 109, 212, 153, 54, 132, 136, 226, 92, 75, 5, 174, 77, 49, 16, 234, 41, 35, 73, 113, 190, 181, 70, 202, 133, 180, 65, 116, 232, 86, 197, 27, 141, 138, 32, 142, 13, 1, 20, 57, 163, 219, 94, 80, 26, 66, 45, 217, 176, 195, 249, 148, 251, 27, 245, 54, 0, 12, 134, 245, 7, 65, 114, 8, 162, 17, 22, 135, 107, 189, 0, 121, 141, 237, 133, 97, 224, 137, 113, 155, 90, 43, 148, 211, 242, 72, 163, 254, 94, 238, 153, 179, 59, 203, 185, 195, 115, 46, 132, 160, 173, 161, 168, 26, 146, 108, 27, 171, 98, 156, 26, 135, 31, 240, 119, 4, 162, 84, 40, 79, 46, 182, 122, 115, 255, 0, 103, 99, 51, 214, 137, 128, 118, 8, 220, 236, 30, 211, 171, 40, 158, 147, 175, 179, 167, 3, 71, 79, 72, 199, 249, 141, 140, 15, 137, 116, 241, 152, 234, 252, 44, 90, 21, 48, 141, 170, 7, 112, 55, 147, 14, 63, 182, 91, 252, 173, 34, 184, 189, 180, 214, 225, 107, 175, 215, 29, 16, 29, 180, 151, 105, 141, 204, 154, 165, 26, 19, 123, 16, 66, 104, 232, 173, 228, 62, 48, 109, 195, 217, 21, 218, 35, 135, 151, 177, 49, 147, 174, 72, 55, 161, 202, 140, 72, 213, 197, 29, 21, 123, 63, 144, 75, 213, 193, 8, 11, 245, 131, 122, 155, 22, 45, 150, 73, 127, 146, 73, 171, 106, 208, 69, 12, 215, 39, 86, 165, 245, 219, 145, 59, 106, 17, 84, 12, 135, 106, 176, 147, 236, 249, 19, 68, 84, 213, 107, 156, 149, 96, 112, 205, 202, 213, 69, 216, 154, 193, 171, 121, 34, 62, 134, 55, 12, 213, 179, 10, 54, 220, 208, 164, 130, 184, 16, 144, 124, 60, 116, 246, 52, 92, 65, 195, 48, 105, 59, 140, 187, 218, 154, 227, 121, 203, 97, 49, 50, 114, 215, 19, 229, 12, 104, 216, 42, 198, 36, 119, 125, 26, 64, 130, 217, 134, 199, 35, 147, 134, 10, 8, 75, 46, 160, 23, 188, 136, 197, 37, 44, 46, 163, 63, 252, 226, 197, 139, 23, 71, 180, 89, 204, 184, 19, 59, 184, 69, 20, 10, 74, 178, 199, 63, 42, 145, 33, 16, 216, 221, 155, 24, 18, 233, 34, 69, 188, 24, 72, 73, 199, 48, 250, 249, 138, 102, 25, 184, 82, 162, 232, 7, 51, 30, 246, 141, 130, 9, 86, 36, 250, 130, 39, 1, 155, 250, 153, 224, 97, 199, 67, 194, 229, 117, 168, 27, 72, 38, 49, 52, 140, 127, 11, 39, 161, 145, 193, 167, 174, 200, 120, 80, 81, 48, 118, 139, 245, 158, 170, 20, 231, 184, 83, 245, 214, 17, 88, 111, 200, 128, 218, 159, 59, 21, 138, 240, 145, 71, 234, 170, 210, 184, 98, 125, 167, 38, 227, 58, 238, 196, 93, 239, 136, 241, 198, 102, 79, 99, 202, 190, 141, 230, 214, 56, 25, 74, 93, 243, 205, 13, 255, 199, 50, 167, 38, 243, 59, 145, 25, 171, 51, 110, 154, 177, 239, 224, 140, 53, 14, 208, 82, 67, 97, 27, 235, 63, 5, 25, 232, 113, 231, 234, 234, 33, 92, 155, 102, 233, 187, 232, 241, 131, 179, 197, 235, 161, 41, 138, 98, 112, 253, 85, 76, 113, 144, 92, 2, 3, 126, 105, 251, 24, 196, 71, 254, 247, 90, 36, 61, 209, 255, 192, 134, 254, 122, 12, 21, 13, 52, 178, 205, 106, 49, 25, 139, 16, 18, 31, 193, 0, 29, 44, 172, 236, 216, 11, 212, 46, 85, 33, 122, 242, 13, 124, 193, 44, 114, 202, 107, 241, 239, 129, 196, 189, 236, 157, 188, 31, 38, 230, 23, 77, 157, 59, 194, 217, 114, 181, 165, 217, 181, 252, 35, 72, 92, 216, 174, 195, 183, 167, 110, 229, 119, 144, 216, 196, 216, 196, 248, 116, 62, 32, 173, 25, 150, 69, 254, 13, 211, 139, 83, 28, 31, 69, 207, 225, 15, 15, 26, 226, 111, 193, 243, 70, 123, 213, 204, 205, 251, 159, 26, 106, 249, 199, 15, 178, 133, 197, 220, 252, 66, 222, 235, 42, 113, 10, 254, 36, 20, 10, 173, 131, 204, 55, 0, 200, 191, 2, 228, 239, 3, 210, 153, 80, 128, 46, 225, 199, 160, 82, 239, 12, 30, 70, 23, 234, 221, 33, 131, 0, 136, 252, 51, 160, 113, 19, 16, 251, 253, 214, 15, 203, 150, 100, 49, 209, 57, 139, 208, 36, 96, 247, 14, 105, 248, 64, 228, 31, 1, 139, 73, 64, 28, 108, 141, 198, 144, 202, 20, 52, 228, 102, 238, 228, 87, 184, 243, 156, 185, 142, 200, 207, 175, 206, 231, 242, 82, 114, 134, 9, 200, 137, 25, 207, 23, 77, 59, 191, 7, 211, 49, 195, 138, 213, 82, 126, 197, 170, 150, 76, 91, 228, 151, 156, 29, 170, 86, 40, 228, 219, 249, 54, 138, 201, 223, 3, 232, 183, 1, 225, 252, 203, 209, 13, 130, 79, 67, 211, 251, 93, 1, 111, 85, 77, 254, 22, 192, 223, 5, 140, 11, 109, 188, 56, 226, 223, 131, 182, 245, 174, 226, 215, 117, 147, 207, 3, 2, 239, 224, 248, 209, 46, 138, 220, 52, 74, 12, 182, 90, 208, 224, 141, 255, 221, 110, 140, 191, 173, 106, 242, 215, 0, 254, 1, 96, 92, 14, 201, 180, 188, 255, 135, 208, 252, 81, 23, 41, 180, 88, 193, 95, 2, 26, 51, 128, 115, 46, 187, 186, 88, 119, 30, 176, 139, 143, 75, 6, 179, 208, 178, 246, 170, 12, 218, 105, 38, 127, 14, 192, 31, 163, 245, 123, 30, 175, 46, 37, 177, 231, 186, 97, 253, 109, 20, 147, 63, 5, 208, 63, 0, 132, 111, 54, 214, 119, 150, 131, 151, 55, 182, 53, 0, 220, 171, 73, 10, 79, 208, 33, 190, 42, 133, 3, 0, 200, 31, 3, 42, 139, 104, 136, 13, 201, 15, 125, 73, 36, 177, 212, 13, 67, 108, 171, 154, 252, 33, 128, 95, 1, 140, 179, 77, 139, 5, 145, 223, 195, 191, 28, 232, 234, 18, 68, 208, 223, 7, 160, 57, 180, 126, 79, 91, 13, 194, 63, 83, 23, 57, 198, 119, 204, 192, 250, 215, 186, 97, 253, 251, 170, 39, 191, 13, 104, 172, 215, 125, 96, 32, 87, 55, 255, 15, 186, 230, 3, 91, 85, 147, 207, 2, 248, 143, 0, 227, 82, 187, 163, 31, 201, 224, 135, 208, 58, 119, 212, 221, 126, 63, 109, 228, 55, 1, 104, 62, 60, 230, 250, 33, 144, 68, 220, 236, 230, 152, 155, 84, 39, 46, 40, 161, 100, 46, 250, 141, 253, 15, 32, 240, 248, 33, 61, 112, 209, 151, 140, 255, 8, 35, 97, 136, 233, 57, 53, 104, 226, 82, 160, 164, 167, 3, 37, 153, 158, 129, 203, 190, 104, 188, 128, 69, 142, 126, 254, 59, 131, 198, 159, 162, 198, 108, 185, 130, 135, 87, 137, 43, 129, 198, 104, 7, 26, 229, 247, 176, 76, 36, 113, 53, 232, 36, 115, 136, 27, 71, 56, 33, 192, 116, 36, 113, 173, 9, 115, 168, 163, 60, 89, 126, 165, 43, 122, 240, 67, 77, 240, 67, 29, 101, 141, 216, 63, 113, 189, 169, 227, 149, 67, 82, 40, 236, 18, 67, 200, 206, 24, 98, 182, 210, 87, 193, 176, 88, 184, 50, 64, 79, 114, 186, 43, 111, 122, 33, 192, 53, 13, 121, 43, 190, 254, 12, 241, 37, 125, 134, 80, 122, 34, 47, 125, 136, 32, 63, 61, 32, 207, 10, 14, 5, 78, 50, 5, 250, 250, 75, 200, 193, 95, 66, 228, 225, 116, 58, 165, 203, 179, 232, 148, 129, 62, 128, 97, 177, 133, 69, 9, 69, 126, 9, 30, 29, 207, 192, 195, 71, 216, 207, 177, 193, 63, 193, 142, 91, 152, 101, 46, 138, 18, 81, 210, 81, 212, 243, 101, 191, 242, 136, 116, 199, 242, 144, 39, 38, 79, 119, 146, 193, 177, 78, 28, 207, 107, 82, 229, 208, 241, 76, 194, 104, 114, 88, 135, 120, 231, 1, 22, 116, 219, 58, 82, 183, 146, 47, 56, 16, 64, 247, 254, 31, 80, 75, 1, 2, 45, 0, 20, 0, 0, 0, 8, 0, 2, 133, 51, 65, 255, 203, 203, 154, 224, 8, 0, 0, 72, 41, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 80, 75, 5, 6, 0, 0, 0, 0, 1, 0, 1, 0, 46, 0, 0, 0, 254, 8, 0, 0, 0, 0 };
      structure = PersistenceManager<Structure>.LoadFromBuffer(buffer, this.Structure.TypeLookupTable, true);
      structure.TypeLookupTable = this.Structure.TypeLookupTable;




      List<string> inputNames = new List<string>();
      inputNames.AddRange(structure.StartPoint.InputNames);
      inputNames.Add("Msg");
      SetInputs(inputNames.ToArray());



      int outputCount = 0;
      if (structure.Result != null)
        outputCount += 1;

      if (structure.OutputPoint != null)
        outputCount += structure.OutputPoint.OutputCount;


      string[] outputList = new string[outputCount];

      if (structure.Result != null)
        outputList[0] = Structure.Result.Name;

      if (structure.OutputPoint != null)
      {
        int firstInput = 0;
        if (structure.Result != null)
          firstInput += 1;

        for (int i = firstInput; i < structure.OutputPoint.OutputCount + firstInput; i++)
        {
          outputList[i] = structure.OutputPoint.OutputNames[i - firstInput];
        }
      }

      SetOutputs(outputList);

    }

    protected override IEntity doExecute()
    {
      structure.Restart();

      for (int i = 0; i < InputCount; i++)
      {
        if (i < structure.StartPoint.InputCount)
          structure.StartPoint.SetInput(i, GetInput(i));
        else
        {
          ScalarVar sv = structure.ScalarVars.Where(x => x.DisplayText == this.InputNames[i]).FirstOrDefault();
          if ((sv != null) && (GetValue(i) != null))
          {
            sv.RawValue = GetValue(i);
          }
        }
      }


      if (structure.OutputPoint != null)
      {
        int firstInput = 0;
        if (structure.Result != null)
          firstInput += 1;

        for (int i = firstInput; i < structure.OutputPoint.OutputCount + firstInput; i++)
        {
          structure.OutputPoint.SetOutput(i - firstInput, GetOutput(i));
        }
      }

      structure.Execute(false);
      Object result = structure.Result;

      if (structure.Result != null)
        SetValue(0, result);

      return null;
    }
  }
}
